---
phase: 04-whatsapp-integration
plan: 01
type: execute
---

<objective>
Integrate WhatsApp Cloud API to notify the shop owner when customers submit orders.

Purpose: Replace console.log with actual WhatsApp message delivery so orders reach the owner instantly on their phone.
Output: Working order submission flow that sends WhatsApp notification with customer details and board size.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (from frontmatter)
@.planning/phases/03-order-form-validation/03-01-SUMMARY.md

# Key source files
@src/components/order-form.tsx
@src/components/order-form-section.tsx
@src/app/actions/sendInquiry.ts

**Tech stack available:**
- react-hook-form + zod for form validation (existing)
- Server actions pattern (sendInquiry.ts)
- Environment variables via .env.local

**Established patterns:**
- Server actions with zod validation
- Try/catch with error state return
- Console logging for debugging

**Constraining decisions:**
- Phase 3: Console.log submission for now, WhatsApp in Phase 4
- PROJECT.md: WhatsApp is sole notification channel (no email)
- PROJECT.md: Keep WhatsApp costs minimal (free tier: 1000 conversations/month)

**WhatsApp Cloud API Requirements:**
- Meta Business Account with verified business
- WhatsApp Business phone number (can be a test number for development)
- Access token from Meta Developer Portal
- Phone Number ID from WhatsApp Business settings
- Recipient phone number (shop owner's WhatsApp number)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sendWhatsAppOrder server action</name>
  <files>src/app/actions/sendWhatsAppOrder.ts, .env.example</files>
  <action>
Create a server action that sends a WhatsApp message via Cloud API.

**Implementation:**
1. Create `src/app/actions/sendWhatsAppOrder.ts`:
   - Accept order data: name, phone, email, size
   - Use zod to validate input
   - Call WhatsApp Cloud API endpoint: `https://graph.facebook.com/v21.0/{PHONE_NUMBER_ID}/messages`
   - Send text message format with order details
   - Return success/error state

2. Environment variables needed:
   - `WHATSAPP_ACCESS_TOKEN` - Meta API access token
   - `WHATSAPP_PHONE_NUMBER_ID` - WhatsApp Business phone number ID
   - `WHATSAPP_RECIPIENT_PHONE` - Shop owner's phone number (with country code, e.g., 12155551234)

3. Message format:
```
üç´ New Order Request!

Customer: {name}
Phone: {phone}
Email: {email}
Board Size: {size}

Reply to this message or call the customer to confirm.
```

**What to avoid:**
- Don't use third-party WhatsApp libraries (direct fetch is simpler and has no dependencies)
- Don't store the access token in code (use environment variables)
- Don't expose error details to client (generic error message only)
  </action>
  <verify>TypeScript compiles without errors: `npm run build` succeeds</verify>
  <done>Server action exists at src/app/actions/sendWhatsAppOrder.ts with proper types and API call</done>
</task>

<task type="auto">
  <name>Task 2: Integrate WhatsApp into OrderForm</name>
  <files>src/components/order-form.tsx</files>
  <action>
Connect the OrderForm to the sendWhatsAppOrder server action.

**Implementation:**
1. Import the server action
2. Replace the console.log in onSubmit with server action call
3. Handle success/error states:
   - On success: call onSubmitSuccess() as before
   - On error: show toast notification with generic error message
4. Keep console.log as fallback/debug (but call API first)

**What to avoid:**
- Don't block the UI on API errors (show error but don't prevent retry)
- Don't expose API error details to users (use generic "Something went wrong" message)
- Don't remove existing form validation logic
  </action>
  <verify>`npm run build` succeeds, no TypeScript errors</verify>
  <done>OrderForm calls sendWhatsAppOrder on submit, handles success/error gracefully</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>WhatsApp notification system for order submissions</what-built>
  <how-to-verify>
    **Prerequisites:** Set up WhatsApp Cloud API credentials in `.env.local`:
    - WHATSAPP_ACCESS_TOKEN=your_meta_access_token
    - WHATSAPP_PHONE_NUMBER_ID=your_phone_number_id
    - WHATSAPP_RECIPIENT_PHONE=shop_owner_phone_number

    **To get credentials:**
    1. Go to https://developers.facebook.com/apps
    2. Create or select an app with WhatsApp product
    3. In WhatsApp > API Setup, get:
       - Temporary access token (or generate a permanent one)
       - Phone number ID from "From" dropdown
    4. Use your WhatsApp number as recipient for testing

    **Test the integration:**
    1. Run: `npm run dev`
    2. Visit: http://localhost:3000/order
    3. Select a board size (any)
    4. Fill in test details:
       - Name: Test Customer
       - Phone: 1234567890
       - Email: test@example.com
    5. Click "Submit Order Request"
    6. Check shop owner's WhatsApp for notification message
    7. Confirm success message appears in UI

    **Expected behavior:**
    - Form shows success state
    - WhatsApp message received with order details
    - No console errors
  </how-to-verify>
  <resume-signal>Type "approved" if WhatsApp message received correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Server action properly typed and handles errors
- [ ] OrderForm integrates with server action
- [ ] WhatsApp message received (verified in checkpoint)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- WhatsApp notification received on form submission
- Error handling graceful (doesn't break UI on API failure)
- Phase 4 complete (final phase of milestone)
</success_criteria>

<output>
After completion, create `.planning/phases/04-whatsapp-integration/04-01-SUMMARY.md` following the summary template.

Update STATE.md:
- Phase: 4 of 4 complete
- Progress: 100%
- Status: Milestone complete

Update ROADMAP.md:
- Mark Phase 4 as complete
- Update progress table
</output>
