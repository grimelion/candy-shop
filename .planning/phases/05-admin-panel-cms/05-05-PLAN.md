---
phase: 05-admin-panel-cms
plan: 05
type: execute
---

<objective>
Build the content editor and board editor — completing the admin CMS.

Purpose: The owner needs to edit page-level texts (hero headline, section titles, testimonials) and board-specific data (prices, descriptions, images). This plan completes the admin panel.

Output: /admin/content editor for all site section texts; /admin/boards editor for board prices, descriptions, and image uploads to Vercel Blob.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/site-config.ts
@src/types/site-config.ts
@src/content/sections.ts
@src/components/board-size-selector.tsx
@src/app/admin/site-info/actions.ts
@.planning/phases/05-admin-panel-cms/05-04-SUMMARY.md

**Tech stack available:** Next.js 15 App Router, TypeScript, Tailwind CSS v4, shadcn/ui (Button, Card, Input, Label, Textarea), react-hook-form, zod, getSiteConfig/saveSiteConfig/uploadBoardImage from src/lib/site-config.ts

**Established patterns:**
- Admin editor pattern established in 05-04: async server page → client form with defaultValues → server action validates with zod, merges with current config, calls saveSiteConfig()
- Image upload: use `uploadBoardImage(boardId, file)` from src/lib/site-config.ts which returns a Vercel Blob URL
- revalidatePath() after saves to refresh admin pages

**Constraining decisions:**
- No rich text editor — plain textarea for all text fields (the owner edits copy occasionally, markdown is not needed)
- Board images: upload replaces the image for that board size only; other board sizes unchanged
- Testimonials: edit existing 3 only — no add/remove in this phase (keep scope contained)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content editor for all site section texts</name>
  <files>src/app/admin/content/page.tsx, src/app/admin/content/actions.ts</files>
  <action>
Create `src/app/admin/content/actions.ts`:
- `"use server"` directive
- Define Zod schema for all section content fields:
  ```ts
  const contentSchema = z.object({
    hero: z.object({ headline: z.string().min(1), subhead: z.string().min(1), primaryCTA: z.string().min(1) }),
    featured: z.object({
      title: z.string().min(1),
      items: z.array(z.object({ title: z.string(), description: z.string(), image: z.string() }))
    }),
    gallery: z.object({ title: z.string().min(1), description: z.string().min(1) }),
    b2b: z.object({
      title: z.string().min(1),
      description: z.string().min(1),
      services: z.array(z.string())
    }),
    testimonials: z.object({
      title: z.string().min(1),
      items: z.array(z.object({ name: z.string(), review: z.string(), rating: z.coerce.number().min(1).max(5) }))
    }),
    location: z.object({ title: z.string().min(1), description: z.string().min(1) })
  })
  ```
- Export `saveContentAction(formData: FormData)`:
  - Parse formData — nested fields use dot notation (e.g., `hero.headline`, `featured.items.0.title`)
  - Use a helper to reconstruct the nested object from FormData entries
  - Validate with schema
  - Fetch current config, merge content fields, call `saveSiteConfig()`
  - `revalidatePath('/admin/content')` and `revalidatePath('/')` after save
  - Return `{ success: true }` or `{ error: string }`

Create `src/app/admin/content/page.tsx` (async Server Component):
- Fetch config: `const config = await getSiteConfig()`
- Create a `ContentForm` client component with sections rendered as collapsible fieldsets or tabs using Radix Tabs (already in dependencies):
  - **Hero**: headline (Input), subhead (Textarea), primaryCTA (Input)
  - **Featured section**: title (Input), then 3 items each with title (Input) + description (Textarea)
  - **Gallery**: title (Input), description (Textarea)
  - **B2B**: title (Input), description (Textarea), services (4 Textareas for each service string)
  - **Testimonials**: title (Input), then 3 testimonials each with name (Input), review (Textarea), rating (Input type=number min=1 max=5)
  - **Location**: title (Input), description (Textarea)
- "Save All Changes" button at bottom
- Pass `defaultValues={config}` from server page to ContentForm
- On save: show success toast or error message

**FormData nesting tip**: Use array-indexed field names like `featured.items[0].title` — in the server action, use a simple recursive parser or JSON.parse approach:
- Alternative: serialize the entire config as JSON in a hidden input (`<input type="hidden" name="content" value={JSON.stringify(config)} />`), and update the values client-side before submit — simpler than nested FormData parsing
  </action>
  <verify>
1. `npm run build` passes
2. Visit /admin/content — all sections render with current content pre-filled
3. Edit the hero headline to "Test Headline" → Save → success toast
4. Reload /admin/content — "Test Headline" persists
5. Visit http://localhost:3000 — hero shows "Test Headline" (after ISR revalidation)
6. Restore original headline and save
  </verify>
  <done>Content editor pre-populates all section texts, saves to Vercel Blob, changes propagate to live site</done>
</task>

<task type="auto">
  <name>Task 2: Create board editor with image upload</name>
  <files>src/app/admin/boards/page.tsx, src/app/admin/boards/actions.ts</files>
  <action>
Create `src/app/admin/boards/actions.ts`:
- `"use server"` directive
- Export `saveBoardsAction(formData: FormData)`:
  - Extract board data: iterate over board IDs (small, medium, large)
  - For each board: extract `name`, `price`, `weight`, `serves`, `description`, `popular` (checkbox) from formData
  - Handle image upload: `const imageFile = formData.get('image_small') as File | null` — if a file was uploaded (file.size > 0), call `uploadBoardImage(boardId, imageFile)` to get new Vercel Blob URL; otherwise keep existing `imageUrl`
  - Validate required fields with zod
  - Fetch current config, update `config.boards` array with edited data
  - Call `saveSiteConfig(updated)`
  - `revalidatePath('/admin/boards')` and `revalidatePath('/order')` after save
  - Return `{ success: true }` or `{ error: string }`

Create `src/app/admin/boards/page.tsx` (async Server Component):
- Fetch config: `const config = await getSiteConfig()`
- Create `BoardsForm` client component (enctype="multipart/form-data" for image uploads):
  - Render one Card per board size (3 cards: Small, Medium, Large)
  - Each card contains:
    - Name (Input, pre-filled)
    - Price (Input, pre-filled e.g. "Starting at $45")
    - Weight (Input, pre-filled e.g. "1lb")
    - Serves (Input, pre-filled e.g. "1-3 people")
    - Description (Textarea, pre-filled)
    - Most Popular (Checkbox)
    - Current image: `<img src={board.imageUrl} className="w-32 h-32 object-cover rounded" />`
    - Replace image: `<input type="file" name="image_{board.id}" accept="image/*" />`
  - "Save All Boards" button at bottom of the form (submits all 3 boards at once)
- On save: show success toast or error
- Pass `defaultValues={config.boards}` from server page to BoardsForm

**Image upload note**: The form must have `encType="multipart/form-data"` prop on the `<form>` element. File inputs use `name="image_small"`, `name="image_medium"`, `name="image_large"`. In the server action, check `file.size > 0` before uploading — browsers send an empty File object when no file is selected.
  </action>
  <verify>
1. `npm run build` passes
2. Visit /admin/boards — 3 board cards render with current prices and images
3. Change Small board price to "$50" → Save → success toast
4. Visit http://localhost:3000/order — Small board shows "$50" (after ISR revalidation or next request)
5. Upload a new image for Small board → Save → current image preview updates on reload
6. Restore original price and save
  </verify>
  <done>Board editor pre-populates all board fields, saves price/description changes, uploads new images to Vercel Blob, changes appear on /order page</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin CMS: content editor (/admin/content) for all site texts + board editor (/admin/boards) with image uploads</what-built>
  <how-to-verify>
    1. Run: `npm run dev` (or `vercel dev` for full Blob support)
    2. Login at http://localhost:3000/admin/login
    3. **Content Editor:**
       - Visit /admin/content — all section texts pre-filled
       - Edit hero headline → Save → success toast appears
       - Reload /admin/content — change persists
       - Visit http://localhost:3000 — hero shows new headline
       - Restore original and save
    4. **Board Editor:**
       - Visit /admin/boards — 3 board cards with current data
       - Edit medium board price → Save → success toast
       - Visit http://localhost:3000/order — medium board shows updated price
       - Upload a new image for one board → Save → image updates on /order
       - Restore original price and save
    5. **Navigation check:**
       - All admin sidebar links work (Store Info, Content, Boards)
       - Logout works from any admin page
    **Note on Vercel Blob locally:** BLOB_READ_WRITE_TOKEN must be set for saves to persist. Use `vercel env pull .env.local` after connecting the project to Vercel to get the token. Without it, getSiteConfig returns defaults (site looks normal) but saves will fail with a clear error.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] /admin/content editor works for all 6 section types
- [ ] /admin/boards editor works for all 3 board sizes including image upload
- [ ] Changes from content editor propagate to home page (/)
- [ ] Changes from board editor propagate to order page (/order)
- [ ] `npm run lint` passes
- [ ] All admin pages protected by middleware (verify by clearing cookies)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Owner can edit any site text through the admin panel without touching code
- Owner can update board prices, descriptions, and photos through the admin panel
- Phase 5 complete — Admin Panel (CMS) fully functional
  </success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel-cms/05-05-SUMMARY.md`:

```markdown
---
phase: 05-admin-panel-cms
plan: 05
subsystem: admin-ui
tags: [admin, cms, vercel-blob, image-upload, react-hook-form]

requires:
  - phase: 05-admin-panel-cms plan 04
    provides: Admin layout, store info editor, admin editor pattern
provides:
  - /admin/content editor for all site section texts
  - /admin/boards editor with image upload to Vercel Blob
  - Complete CMS — all site content editable without code changes
affects: []

tech-stack:
  added: []
  patterns:
    - multipart/form-data for image uploads in server actions
    - File.size > 0 check to detect actual image uploads vs empty file input

key-files:
  created:
    - src/app/admin/content/page.tsx
    - src/app/admin/content/actions.ts
    - src/app/admin/boards/page.tsx
    - src/app/admin/boards/actions.ts

key-decisions:
  - "Plain textarea for all text fields — no rich text editor (occasional use, not needed)"
  - "Testimonials: edit existing 3 only — add/remove deferred"

patterns-established:
  - Image upload: multipart form → server action → uploadBoardImage() → Blob URL stored in config

issues-created: []
---

# Phase 5 Plan 5: Admin UI - Content & Boards Summary

**[Substantive one-liner]**

## Accomplishments

## Files Created/Modified

## Decisions Made

## Issues Encountered

## Next Step

Phase 5 complete — Admin Panel (CMS) fully functional.
```
</output>
