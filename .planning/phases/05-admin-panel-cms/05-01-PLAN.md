---
phase: 05-admin-panel-cms
plan: 01
type: execute
---

<objective>
Set up password-protected authentication for the admin panel.

Purpose: The owner needs a secure way to access the CMS without a database or auth service. Middleware-based JWT cookie auth is the right fit — zero external dependencies beyond `jose`, which is already the recommended JWT library for Next.js Edge runtime.

Output: Working login/logout flow; all /admin/* routes redirect unauthenticated visitors to /admin/login.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/actions/sendInquiry.ts
@src/components/order-form.tsx

**Tech stack available:** Next.js 15 App Router, TypeScript, Tailwind CSS v4, react-hook-form, zod, shadcn/ui (Button, Card, Input, Label, Form)

**Established patterns:** Server actions with "use server" directive, Zod validation at boundaries, react-hook-form with zodResolver

**Constraining decisions:**
- Phase 3: react-hook-form + zod is the form pattern — use same pattern for login form
- Use `jose` (NOT `jsonwebtoken`) — jsonwebtoken has CommonJS issues with Next.js Edge/middleware runtime
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install jose and create admin middleware</name>
  <files>src/middleware.ts</files>
  <action>
Run `npm install jose` to add the JWT library.

Create `src/middleware.ts`:
- Import `jwtVerify` from `jose`, `NextResponse` from `next/server`
- Export a `middleware` function that:
  1. Checks if the request path starts with `/admin` but is NOT `/admin/login` (allow login page through)
  2. Reads the `admin_session` cookie value from `request.cookies.get('admin_session')?.value`
  3. If missing: redirect to `/admin/login`
  4. If present: call `jwtVerify(token, new TextEncoder().encode(process.env.ADMIN_SECRET))` inside try/catch
  5. If verification throws: redirect to `/admin/login`
  6. If verification succeeds: `return NextResponse.next()`

- Export `config` with `matcher: ['/admin/:path*']` to scope middleware to admin routes only

Add to `.env`:
```
ADMIN_PASSWORD=changeme
ADMIN_SECRET=replace-with-32-chars-minimum-random-string
```
  </action>
  <verify>Run `npm run build` — no TypeScript errors. Visit http://localhost:3000/admin — redirects to /admin/login (404 for the login page is OK at this stage since it doesn't exist yet).</verify>
  <done>Middleware file exists, builds without errors, matcher targets /admin/:path*</done>
</task>

<task type="auto">
  <name>Task 2: Create admin login page and server action</name>
  <files>src/app/admin/login/page.tsx, src/app/admin/login/actions.ts, src/app/admin/actions.ts</files>
  <action>
Create `src/app/admin/login/actions.ts`:
- `"use server"` directive
- Import `SignJWT` from `jose`, `cookies` from `next/headers`, `redirect` from `next/navigation`
- Export `loginAction(formData: FormData)`:
  1. Extract `password` from formData
  2. Compare with `process.env.ADMIN_PASSWORD` using `===` (the password IS the secret)
  3. On mismatch: return `{ error: "Invalid password" }`
  4. On match: create JWT — `new SignJWT({ admin: true }).setProtectedHeader({ alg: 'HS256' }).setExpirationTime('24h').sign(new TextEncoder().encode(process.env.ADMIN_SECRET))`
  5. Set cookie: `(await cookies()).set('admin_session', token, { httpOnly: true, secure: process.env.NODE_ENV === 'production', sameSite: 'strict', path: '/admin', maxAge: 86400 })`
  6. Call `redirect('/admin')`

Create `src/app/admin/actions.ts`:
- `"use server"` directive
- Export `logoutAction()`: delete the `admin_session` cookie, redirect to `/admin/login`

Create `src/app/admin/login/page.tsx` (Client Component):
- `"use client"` directive
- Center a Card on the page (full-screen height, flex center)
- Card has title "Admin Login", a password Input (type="password", name="password"), and a "Login" Button
- Use react-hook-form + zod (schema: `{ password: z.string().min(1) }`)
- On submit: call `loginAction(formData)` via `startTransition` — handle returned `{ error }` to display error message below the button
- No layout.tsx yet — the login page renders standalone (just the centered card, no nav)
  </action>
  <verify>
1. `npm run build` passes without TypeScript errors
2. `npm run dev` starts
3. Visit http://localhost:3000/admin — redirects to /admin/login
4. Login page renders centered card with password field
5. Enter wrong password → error message "Invalid password" appears
6. Enter correct password (ADMIN_PASSWORD from .env) → redirects to /admin (will 404 until plan 05-04)
  </verify>
  <done>Login form renders, wrong password shows error, correct password sets httpOnly cookie and redirects, cookie survives page refresh on /admin</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Admin authentication: middleware route protection + login page + JWT cookie session + logout action</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Visit: http://localhost:3000/admin — should redirect to /admin/login
    3. Enter wrong password — "Invalid password" error should appear
    4. Enter correct password (from .env ADMIN_PASSWORD) — should redirect to /admin (404 is expected, admin pages aren't built yet)
    5. Visit http://localhost:3000/admin again directly — should NOT redirect (cookie is set)
    6. Clear cookies in browser devtools → Storage → Cookies → delete admin_session
    7. Visit http://localhost:3000/admin again — should redirect to /admin/login
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds with no TypeScript errors
- [ ] `npm run dev` starts cleanly
- [ ] Visiting /admin without cookie redirects to /admin/login
- [ ] Wrong password shows error, does not set cookie
- [ ] Correct password sets httpOnly cookie and redirects to /admin
- [ ] .env has ADMIN_PASSWORD and ADMIN_SECRET
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors introduced
- Admin routes protected by cookie authentication
  </success_criteria>

<output>
After completion, create `.planning/phases/05-admin-panel-cms/05-01-SUMMARY.md`:

```markdown
---
phase: 05-admin-panel-cms
plan: 01
subsystem: auth
tags: [next.js, middleware, jose, jwt, admin]

requires: []
provides:
  - Admin middleware protecting /admin/* routes
  - Login page with password form
  - JWT cookie session (24h)
  - Logout action
affects: [05-admin-panel-cms]

tech-stack:
  added: [jose]
  patterns:
    - Middleware JWT verification with jose
    - httpOnly cookie session for admin

key-files:
  created:
    - src/middleware.ts
    - src/app/admin/login/page.tsx
    - src/app/admin/login/actions.ts
    - src/app/admin/actions.ts

key-decisions:
  - "jose for JWT in middleware (not jsonwebtoken — Edge runtime incompatibility)"
  - "ADMIN_PASSWORD env var plain string comparison — no bcrypt needed for single-owner"

patterns-established:
  - Admin server actions live in src/app/admin/actions.ts or src/app/admin/*/actions.ts

issues-created: []
---

# Phase 5 Plan 1: Admin Auth Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/middleware.ts` - Admin route protection
- `src/app/admin/login/page.tsx` - Login form
- `src/app/admin/login/actions.ts` - Login server action
- `src/app/admin/actions.ts` - Logout server action

## Decisions Made

[Key decisions and rationale]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for 05-02-PLAN.md
```
</output>
